@implements IAsyncDisposable

@code {
    [CascadingParameter] public HubConnection? Hub { get; set; }
    List<IDisposable> Events = new();
    protected string? GroupId;

    protected void On<T>(Action<T> action)
    {
        if (Hub != null)
            Events.Add(Hub.On<T>(typeof(T).Name, evt =>
            {
                action(evt);
                StateHasChanged();
            }));
    }

    protected async Task On<T>(string groupId, Action<T> action) where T : SparcNotification
    {
        if (Hub != null)
        {
            if (GroupId != groupId)
            {
                GroupId = groupId;
                await Hub!.InvokeAsync("Watch", GroupId);
            }

            Events.Add(Hub.On<T>(typeof(T).Name, evt =>
            {
                
                var equals = evt.GroupId == GroupId;
                if (equals)
                {
                    action(evt);
                    StateHasChanged();
                }
            }));
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (GroupId != null)
            await Hub!.InvokeAsync("StopWatching", GroupId);

        foreach (var evt in Events)
            evt.Dispose();

        Events.Clear();
    }
}
