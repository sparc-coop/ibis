@inherits LayoutComponentBase

<div class="main-layout @(IsRoom ? "mini" : "" )">
    <header>
        <a href="/">
            <figure class="logo">
                @if (IsRoom)
                {
                    <img src="/images/logo_icon.png" alt="Ibis" />
                }
                else
                {
                    <img src="/images/logo_2x.png" alt="Ibis" />
                }
                <figcaption>Ibis</figcaption>
            </figure>
        </a>

        <nav>
            <AuthorizeView>
                <Authorized>
                    <ul>
                        <li>
                            <a href="/">
                                <img src="../icons/dashboard.svg" alt="Your Rooms" />
                            </a>
                        </li>

                        @if (User != null)
                        {
                            <li class="@(ShowMenu ? "open" : "")" @onclick="@(e => ShowMenu = !ShowMenu)">
                                <Avatar User="User" />
                                <img src="../icons/down-arrow.png" class="arrow" alt="Account Settings" />
                                <ul>
                                    <li>
                                        <button @onclick="@EditAvatar">Edit Your Avatar</button>
                                    </li>
                                    <li>
                                        <a href="account" @onclick="@(e => ShowMenu = !ShowMenu)">Account Settings</a>
                                    </li>
                                    <li>
                                        <button class="logout" @onclick="BeginLogout">
                                            Log Out
                                        </button>
                                    </li>
                                </ul>
                            </li>
                        }
                    </ul>
                </Authorized>
            </AuthorizeView>
        </nav>
    </header>

    <main>
        @Body
    </main>
</div>

<CascadingBlazoredModal HideCloseButton=true />

@if (ShowOnboarding)
{
    <Ibis.Web.Onboarding.Index />
}

@inject SignOutSessionStateManager SignOutManager
@inject AuthenticationStateProvider AuthenticationStateProvider

@code {
    UserAvatar? User;
    bool ShowMenu;
    bool IsRoom;
    bool ShowOnboarding;

    protected override async Task OnParametersSetAsync()
    {
        IsRoom = Nav.Uri.Contains("rooms/");

        if (User != null)
            return;

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            User = await Api.GetUserAsync();
            if (User != null && User.Language == null)
                ShowOnboarding = true;
        }
    }

    void EditAvatar()
    {
        ShowMenu = false;
        ShowOnboarding = true;
    }

    private async Task BeginLogout(MouseEventArgs args)
    {
        await SignOutManager.SetSignOutState();
        Nav.NavigateTo("authentication/logout");
    }
}