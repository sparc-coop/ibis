<form class="new-message" @onsubmit=SendText>
    <Avatar User="Me" SpillBackground=true CanEdit=true />
    <textarea type="text" placeholder="Type something..." @bind="Text" @bind:event="oninput" @onkeydown=MaybeSendText @onkeydown:preventDefault="preventDefault" />
    @if (IsSpeak)
    {
        <button @onclick="ShowSpeakModal" aria-label="Speak">
            Speak <img src="icons/Speech.svg" />
        </button>
    }
    else
    {
        <button @onclick="SendText" aria-label="Send">
            Send <img src="icons/send.svg" />
        </button>
    }

    <footer>
        <button @onclick="ShowUploadModal" class="select-upload" title="Upload file">
            <UploadIcon />
        </button>
        
        <span>Call me</span>
        <span>Text me</span>
    </footer>
</form>

@code {
    [Parameter] public GetRoomResponse Room { get; set; } = null!;
    [CascadingParameter] public UserAvatar? Me { get; set; }
    string? Text;
    bool IsSpeak => string.IsNullOrWhiteSpace(Text);
    bool preventDefault = false;

    async Task MaybeSendText(KeyboardEventArgs args)
    {
        if (args.Code == "Enter" && !args.ShiftKey)
        {
            preventDefault = true;
            await SendText();
        }
        else
        {
            preventDefault = false;
        }
    }

    async Task SendText()
    {
        var text = Text?.Trim('\r', '\n', ' ');
        Text = "";
        StateHasChanged();

        var newMessage = await Api.TypeMessageAsync(new TypeMessageRequest { RoomId = Room.RoomId, Text = text });
    }


    void ShowUploadModal()
    {
        var parameters = new ModalParameters();
        parameters.Add(nameof(Upload.RoomId), Room.RoomId);
        Modal.Show<Upload>("Upload", parameters);
    }

    async Task ShowSpeakModal()
    {
        var modal = Modal.Show<Speak>("Send a voice message...");
        var result = await modal.Result;
        if (!result.Cancelled)
        {
            Text = (string)result.Data;
            await SendText();
        }
    }

}
