@using System.Threading.Channels
@inherits RealtimeComponent

<form class="new-message @(SelectedMessage != null ? "editing" : "")" @onsubmit=SendText>
    <Avatar User="Me" EditTab="Avatar" />
    @if (Me?.LanguageIsRTL == false)
    {
        <textarea aria-label="Message" type="text" class="ibis-ignore" disabled="@IsListening" placeholder="Type something..." @ref=TextArea @bind="Text" @bind:event="oninput" @onkeydown=MaybeSendText @onkeydown:preventDefault="preventDefault" />
    }
    else
    {
        <textarea aria-label="Message" type="text" class="ibis-ignore" dir="rtl" disabled="@IsListening" placeholder="Type something..." @ref=TextArea @bind="Text" @bind:event="oninput" @onkeydown=MaybeSendText @onkeydown:preventDefault="preventDefault" />
    }
    
    @if (IsSpeak)
    {
        <button type="button" @onclick="BeginListeningAsync" aria-label="Speak">
            <RecordIcon />
            @(IsListening ? "Recording..." : "Record")
        </button>
    }
    else
    {
        if (SelectedMessage != null)
        {
            <button type="button" class="cancel" @onclick=CancelEdit>
                Cancel
            </button>
        }
        <button type="submit" @onclick="SendText" aria-label="Send">
            <SendIcon />
            @(SelectedMessage == null ? "Send" : "Save")
        </button>
    }

    <footer>
        <button class="action" @onclick="ShowUploadModal" title="Upload file">
            <UploadIcon />
            Upload a file
        </button>
        <button class="action">
            <SmsIcon />
            Connect via SMS
        </button>
        <button class="action">
            <PhoneIcon />
            Connect via Phone
        </button>
    </footer>
</form>

@code {
    [Parameter] public GetRoomResponse Room { get; set; } = null!;
    [Parameter] public string? LanguageString { get; set; }
    [Parameter] public Message? SelectedMessage { get; set; }
    [Parameter] public EventCallback<Message?> OnDoneEditing { get; set; }
    [CascadingParameter] public UserAvatar? Me { get; set; }
    string? Text;
    ElementReference TextArea;
    bool IsSpeak => IsListening || string.IsNullOrWhiteSpace(Text);
    bool preventDefault = false;
    bool LiveMode = true;

    protected override async Task OnParametersSetAsync()
    {
        if (SelectedMessage != null)
        {
            Text = SelectedMessage.Text;
            await TextArea.FocusAsync();
        }
    }

    async Task MaybeSendText(KeyboardEventArgs args)
    {
        if (args.Code == "Enter" && !args.ShiftKey)
        {
            preventDefault = true;
            await SendText();
        }
        else
        {
            preventDefault = false;
        }
    }

    async Task SendText()
    {
        var text = Text?.Trim('\r', '\n', ' ');
        Text = "";
        StateHasChanged();

        var newMessage = await Api.TypeMessageAsync(new TypeMessageRequest { RoomId = Room.RoomId, Text = text, MessageId = SelectedMessage?.Id });
        await TextArea.FocusAsync();

        if (SelectedMessage != null && OnDoneEditing.HasDelegate)
            await OnDoneEditing.InvokeAsync(newMessage);
    }

    async Task CancelEdit()
    {
        Text = "";
        await OnDoneEditing.InvokeAsync(null);
    }

    void ShowUploadModal()
    {
        var parameters = new ModalParameters();
        parameters.Add(nameof(Upload.RoomId), Room.RoomId);
        Modal.Show<Upload>("Upload", parameters);
    }

    DateTime? AudioStartTime;
    Channel<byte[]>? AudioChannel;
    DotNetObjectReference<NewMessage>? objRef;
    bool IsListening;

    async Task BeginListeningAsync()
    {
        if (Me?.Dialect == null)
        {
            var parameters = new ModalParameters();
            parameters.Add("Tab", "Voice");
            var modal = Modal.Show<Onboarding.Index>("Edit Your Avatar", parameters, new ModalOptions { HideHeader = true, Size = ModalSize.Automatic });
            var result = await modal.Result;
            if (result.Data is UserAvatar avatar && avatar.Dialect == null)
                return;
        }

        IsListening = true;
        StateHasChanged();

        if (AudioStartTime != null)
        {
            await StopListeningAsync();
            return;
        }

        objRef = DotNetObjectReference.Create(this);
        AudioStartTime = DateTime.UtcNow;
        AudioChannel = Channel.CreateUnbounded<byte[]>(); ;
        await JS.InvokeVoidAsync("beginListening", objRef);

        On<SpeechRecognizing>(x =>
        {
            Text = x.Text;
        });
        On<SpeechRecognized>(async x =>
        {
            Text = x.Text;
            if (LiveMode)
                await SendText();
            else
                await StopListeningAsync();
        });

        if (Hub?.State == HubConnectionState.Connected)
            await Hub.SendAsync("ReceiveAudio", AudioChannel.Reader);
    }

    async Task StopListeningAsync()
    {
        await JS.InvokeVoidAsync("stopListening");
        AudioStartTime = null;
        AudioChannel?.Writer.Complete();
        objRef = null;
        IsListening = false;
        StateHasChanged();
    }

    [JSInvokable]
    public async Task AudioReceived(byte[] audio)
    {
        if (!LiveMode && DateTime.UtcNow - AudioStartTime > TimeSpan.FromSeconds(30))
        {
            await StopListeningAsync();
            return;
        }

        if (AudioChannel != null)
            await AudioChannel!.Writer.WriteAsync(audio);
    }
}
