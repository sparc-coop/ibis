@implements IAsyncDisposable

<CascadingValue Value="Connection">
    @ChildContent
</CascadingValue>

@inject IAccessTokenProvider AccessTokenProvider
@code {
    [Parameter] public string Url { get; set; } = "";
    [Parameter] public RenderFragment ChildContent { get; set; } = null!;
    [Parameter] public EventCallback<HubConnection> OnConnected { get; set; } = default;

    HubConnection? Connection { get; set; }
    bool IsConnected => Connection?.State == HubConnectionState.Connected;
    string? AccessToken { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var provider = await AccessTokenProvider.RequestAccessToken();
        if (provider.TryGetToken(out var token))
            AccessToken = token.Value;

        Connection = new HubConnectionBuilder()
            .WithUrl(Url, options =>
                {
                    options.AccessTokenProvider = () => Task.FromResult(AccessToken);
                })
            .Build();

        Connection.On("ReceiveMessage", () => { }); // placeholder event so that we can add more On events afterward

        await Connection.StartAsync();

        if (OnConnected.HasDelegate)
            await OnConnected.InvokeAsync(Connection);
    }

    public async ValueTask DisposeAsync()
    {
        if (Connection is not null)
        {
            await Connection.DisposeAsync();
        }
    }
}
