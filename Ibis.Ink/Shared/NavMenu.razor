@using Sparc.Blossom.Authentication;
@using Sparc.Ibis;

<CascadingValue Value="User">
    <div class="user-menu">
        <AuthorizeView>
            <Authorized>
                @if (User != null)
                {
                    <button class="toggle-usermenu">
                        <img src="images/1.png" />
                        <ExpandIcon />
                    </button>
                }
            </Authorized>
            <NotAuthorized>
                <button class="login" @onclick="Login">Login</button>
            </NotAuthorized>
        </AuthorizeView>
    </div>

    <nav>
        <AuthorizeView>
            <Authorized>
                @if (User != null)
                {
                    <div class="navmenu">
                        <header class="navmenu--header">
                            <a href="/webpages"><img class="logo" src="images/logo.png" /></a>
                            <button class="toggle-menu" @onclick="ToggleNav"><ExpandIcon /></button>
                        </header>
                        <div class="navmenu--search">
                            @if (NavSize == "nav-collapsed")
                            {
                                <span @onclick="ToggleNav">
                                    <SearchIcon />
                                </span>
                            } else
                            {
                                <SearchIcon />
                                <input type="text" placeholder="Search..." />
                            }
                        </div>
                        @if (NavSize == "nav-collapsed")
                        {
                            <div class="navmenu--home">
                                <a href="/webpages"><HomeIcon /></a>
                            </div>
                        }
                        <div class="navmenu--webpages">
                            <div class="item">
                                <header>
                                    <a href="/webpages"><img src="images/Sparc-image.png" /></a>
                                    <p class="title"><a href="">Sparc (sparc.coop)</a></p>
                                </header>
                                <ul>
                                    <li><a href="/webpages">Homepage (/)</a></li>
                                    <li><a href="/webpages">Kodekit (/projects/kodekit)</a></li>
                                    <li><a href="/webpages">Law of 100 (/projects/lawof100)</a></li>
                                </ul>
                            </div>
                            <div class="item">
                                <header>
                                    <a href="/webpages"><img src="images/Blossom-image.png" /></a>
                                    <p class="title"><a href="">Blossom</a></p>
                                </header>
                                <ul>
                                    <li><a href="/webpages">Home (/)</a></li>
                                    <li><a href="/webpages">21 Days of Blossom (/21daysofblossom)</a></li>
                                </ul>
                            </div>
                        </div>
                        <button class="add-website"><AddIcon /><span> Add Website</span></button>
                    </div>
                }
            </Authorized>
        </AuthorizeView>
    </nav>
</CascadingValue>

@inject AuthenticationStateProvider AuthenticationStateProvider

@code {
    [Parameter]
    public EventCallback<bool> OnCollapseNav { get; set; }

    protected bool NavIsCollapsed { get; set; }
    string NavSize = "nav-expanded";

    UserAvatar? User;
    bool ShowMenu;
    bool IsRoom;
    string HubUrl => Config["Blossom:Authority"] + "/hub";
    UserBalance? BalanceComponent;
    public string LoginLink = "https://localhost:7117/_login?returnUrl=https%3A%2F%2Flocalhost%3A7083";

    void Login()
    {
        Nav.NavigateTo(LoginLink);
    }

    protected override async Task OnParametersSetAsync()
    {
        IsRoom = Nav.Uri.Contains("rooms/");

        if (User != null)
            return;

        await UpdateUser(AuthenticationStateProvider.GetAuthenticationStateAsync());

        AuthenticationStateProvider.AuthenticationStateChanged += async (state) => await UpdateUser(state);
    }

    void OpenMenu() => ShowMenu = !ShowMenu;

    void EditAvatar()
    {
        ShowMenu = false;
        Modal.Show<Onboarding.Index>("Edit Your Avatar", new ModalOptions { HideHeader = true, Size = ModalSize.Automatic });
    }

    async Task AddFunds() => await BalanceComponent.AddFunds();

    bool isUserBeingGot;
    async Task UpdateUser(Task<AuthenticationState> state)
    {
        var user = (await state).User;

        if (User == null && !isUserBeingGot && user.Identity?.IsAuthenticated == true)
        {
            isUserBeingGot = true;
            User = await Api.GetUserAsync();
            if (User != null && User.Language == null)
            {
                EditAvatar();
            }

            StateHasChanged();
            isUserBeingGot = false;
        }
    }

    void GoToRooms() => Nav.NavigateTo("/rooms");

    private async Task Logout()
    {
        await (AuthenticationStateProvider as BlossomAuthenticationStateProvider)!.LogoutAsync();
    }

    void KeyboardMenu(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            OpenMenu();
        }
    }

    protected async Task ToggleNav()
    {
        NavIsCollapsed = !NavIsCollapsed;

        if (NavIsCollapsed == true)
            NavSize = "nav-collapsed";
        else
            NavSize = "nav-expanded";

        await OnCollapseNav.InvokeAsync(NavIsCollapsed);
    }
}